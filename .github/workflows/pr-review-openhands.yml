name: PR Review by OpenHands

on:
  pull_request:
    types: [labeled, review_requested]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  pr-review:
    if: |
      github.event.label.name == 'review-this' ||
      github.event.requested_reviewer.login == 'openhands-agent'
    runs-on: ubuntu-latest
    env:
      LLM_MODEL: ${{ vars.OPENAI_MODEL }}
      LLM_BASE_URL: ${{ vars.OPENAI_BASE_URL }}
      PR_NUMBER: ${{ github.event.pull_request.number }}
      PR_TITLE: ${{ github.event.pull_request.title }}
      PR_BODY: ${{ github.event.pull_request.body }}
      PR_BASE_BRANCH: ${{ github.event.pull_request.base.ref }}
      PR_HEAD_BRANCH: ${{ github.event.pull_request.head.ref }}
      REPO_NAME: ${{ github.repository }}
    steps:
      - name: Checkout agent-sdk repository
        uses: actions/checkout@v4
        with:
          repository: OpenHands/agent-sdk
          path: agent-sdk

      - name: Checkout PR repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          path: pr-repo
          ref: ${{ github.event.pull_request.head.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          enable-cache: true

      - name: Install GitHub CLI
        run: |
          sudo apt-get update
          sudo apt-get install -y gh

      - name: Install OpenHands dependencies
        run: |
          uv pip install --system "openhands-sdk @ git+https://github.com/OpenHands/agent-sdk.git@main#subdirectory=openhands-sdk"
          uv pip install --system "openhands-tools @ git+https://github.com/OpenHands/agent-sdk.git@main#subdirectory=openhands-tools"

      - name: Check required configuration
        env:
          LLM_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          if [ -z "$LLM_API_KEY" ]; then
            echo "Error: LLM_API_KEY secret is not set."
            exit 1
          fi

          echo "PR Number: $PR_NUMBER"
          echo "PR Title: $PR_TITLE"
          echo "Repository: $REPO_NAME"
          echo "LLM model: $LLM_MODEL"
          if [ -n "$LLM_BASE_URL" ]; then
            echo "LLM base URL: $LLM_BASE_URL"
          fi

      - name: Run PR review
        env:
          LLM_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cd pr-repo
          python ../agent-sdk/examples/03_github_workflows/02_pr_review/agent_script.py

      - name: Upload logs as artifact
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: openhands-pr-review-logs
          path: |
            *.log
            output/
          retention-days: 7
